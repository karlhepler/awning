#!/usr/bin/env bash

set -euo pipefail

# Load environment variables from .env file
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENV_FILE="${SCRIPT_DIR}/.env"

if [[ -f "$ENV_FILE" ]]; then
    # shellcheck disable=SC1090
    source "$ENV_FILE"
fi

# Function to auto-discover Bond Bridge
auto_discover_bond() {
    local bond_id="${BOND_ID:-}"
    if [[ -n "$bond_id" ]]; then
        # Try to resolve using mDNS
        local hostname="${bond_id,,}.local"  # Convert to lowercase
        echo "$hostname"
    else
        echo ""
    fi
}

# Validate required environment variables
if [[ -z "${BOND_TOKEN:-}" ]]; then
    echo "Error: BOND_TOKEN environment variable is not set"
    echo "Please set it in .env file or export it"
    exit 1
fi

# Determine Bond host (IP or hostname)
BOND_HOST="${BOND_HOST:-}"
if [[ -z "$BOND_HOST" ]]; then
    # Try auto-discovery if BOND_ID is set
    BOND_HOST=$(auto_discover_bond)
    if [[ -z "$BOND_HOST" ]]; then
        echo "Error: BOND_HOST environment variable is not set"
        echo "Please set BOND_HOST (IP or hostname) or BOND_ID in .env file"
        exit 1
    fi
fi

if [[ -z "${DEVICE_ID:-}" ]]; then
    echo "Error: DEVICE_ID environment variable is not set"
    echo "Please set it in .env file or export it"
    exit 1
fi

# Base URL for Bond API
BASE_URL="http://${BOND_HOST}/v2/devices/${DEVICE_ID}"

# Function to send action to Bond Bridge
send_action() {
    local action=$1
    curl -s -H "BOND-Token: ${BOND_TOKEN}" \
         -X PUT \
         -d '{}' \
         "${BASE_URL}/actions/${action}"
}

# Function to get current state
get_state() {
    curl -s -H "BOND-Token: ${BOND_TOKEN}" \
         "${BASE_URL}/state" | jq -r '.open'
}

# Function to get device info
get_info() {
    curl -s -H "BOND-Token: ${BOND_TOKEN}" \
         "${BASE_URL}" | jq .
}

# Parse command
COMMAND="${1:-}"

case "$COMMAND" in
    open)
        echo "Opening awning..."
        send_action "Open" > /dev/null
        echo "Awning is opening"
        ;;
    close)
        echo "Closing awning..."
        send_action "Close" > /dev/null
        echo "Awning is closing"
        ;;
    stop)
        echo "Stopping awning..."
        send_action "Stop" > /dev/null
        echo "Awning stopped"
        ;;
    toggle)
        echo "Toggling awning..."
        send_action "ToggleOpen" > /dev/null
        echo "Awning toggled"
        ;;
    status)
        state=$(get_state)
        if [[ "$state" == "1" ]]; then
            echo "Awning is OPEN"
        elif [[ "$state" == "0" ]]; then
            echo "Awning is CLOSED"
        else
            echo "Awning state: $state"
        fi
        ;;
    info)
        echo "Device Information:"
        get_info
        ;;
    help|--help|-h|"")
        cat << EOF
Usage: awning <command>

Commands:
    open      Open the awning
    close     Close the awning
    stop      Stop awning movement
    toggle    Toggle between open and closed
    status    Get current awning state
    info      Get device information
    help      Show this help message

Environment Variables (set in .env file):
    BOND_TOKEN    Bond Bridge authentication token
    BOND_HOST     Bond Bridge hostname or IP (e.g., bond-zzif27980.local)
    BOND_ID       Bond ID (e.g., ZZIF27980) - used for auto-discovery
    DEVICE_ID     Device ID for the awning
EOF
        ;;
    *)
        echo "Error: Unknown command '$COMMAND'"
        echo "Run 'awning help' for usage information"
        exit 1
        ;;
esac
